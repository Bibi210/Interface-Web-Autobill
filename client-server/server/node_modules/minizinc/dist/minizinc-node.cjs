"use strict";var n=require("node:child_process"),t=require("node:events"),e=require("node:readline"),i=require("node:fs/promises"),o=require("node:path"),s=require("node:os");let r={minizinc:"minizinc",_executable:"minizinc"};const u=new Set;class a{constructor(){this.vfs={},this._toRun=[],this.unnamedCount=0}clone(){const n=new a;return n.vfs={...this.vfs},n._toRun=[...this.toRun],n.unnamedCount=this.unnamedCount,n}addString(n){let t=`_mzn_${this.unnamedCount++}.mzn`;for(;t in this.vfs;)t=`_mzn_${this.unnamedCount++}.mzn`;return this._addVirtual(t,n),t}addDznString(n){let t=`_dzn_${this.unnamedCount++}.dzn`;for(;t in this.vfs;)t=`_dzn_${this.unnamedCount++}.dzn`;return this._addVirtual(t,n),t}addJson(n){let t=`_json_${this.unnamedCount++}.json`;for(;t in this.vfs;)t=`_json_${this.unnamedCount++}.json`;return this._addVirtual(t,JSON.stringify(n)),t}_add_toRun(n,t){t&&(n.endsWith(".mzn")||n.endsWith(".mzc")||n.endsWith(".dzn")||n.endsWith(".json")||n.endsWith(".mpc")||n.endsWith(".fzn"))&&-1===this._toRun.indexOf(n)&&this._toRun.push(n)}_addVirtual(n,t,e=!0){this.vfs[n]=t,this._add_toRun(n,e)}addFile(n,t=null,e=!0){"string"==typeof t?this._addVirtual(n,t,e):this._add_toRun(n.use)}_run(a,c,l){const d=new t;let f=null;return d.on("sigint",(()=>{f?f.kill("SIGINT"):f=!1})),(async()=>{const t=["--json-stream"],h=await i.mkdtemp(o.join(s.tmpdir(),"mzn"));if(c){let n=`_mzn_${this.unnamedCount++}.mpc`;for(;n in this.vfs;)n=`_mzn_${this.unnamedCount++}.mpc`;n=o.join(h,n),await i.writeFile(n,JSON.stringify(c)),t.push(n)}for(const n in this.vfs)await i.writeFile(o.join(h,n),this.vfs[n]);if(!1===f)return void d.emit("exit",{code:0});f=n.spawn(r._executable,[...t,...a.map((n=>l&&-1!==l.indexOf(n)?o.join(h,n):n)),...this._toRun.map((n=>n in this.vfs?o.join(h,n):n))]),u.add(f);e.createInterface(f.stdout).on("line",(async n=>{try{const t=JSON.parse(n);if("location"in t&&"filename"in t.location&&0===t.location.filename.indexOf(h)&&(t.location.filename=t.location.filename.substring(h.length)),"stack"in t&&Array.isArray(t.stack))for(const n of t.stack)"location"in n&&"filename"in n.location&&0===n.location.filename.indexOf(h)&&(n.location.filename=n.location.filename.substring(h.length));d.emit(t.type,t)}catch(t){d.emit("stdout",{type:"stdout",value:n})}}));e.createInterface(f.stderr).on("line",(async n=>{d.emit("stderr",n)})),f.on("exit",(async(n,t)=>{u.delete(f);const e={type:"exit",code:"SIGINT"===t?null:n};if(l){e.outputFiles={};for(const n of l)try{e.outputFiles[n]=await i.readFile(n,{encoding:"utf8"})}catch(t){try{e.outputFiles[n]=await i.readFile(o.join(h,n),{encoding:"utf8"})}catch(t){e.outputFiles[n]=null}}}d.emit("exit",e),i.rm(h,{recursive:!0,force:!0})}))})(),d}check(n){const t={...n},e=this._run(["--model-check-only"],t.options),i=[];return e.on("error",(n=>i.push(n))),new Promise(((n,t)=>{e.on("exit",(t=>n(i)))}))}interface(n){const t={...n},e=this._run(["-c","--model-interface-only"],t.options),i=[];let o=null;return e.on("error",(n=>i.push(n))),e.on("interface",(n=>o=n)),new Promise(((n,t)=>{e.on("exit",(e=>{0===e.code?n(o):t(i)}))}))}compile(n){const t={...n};let e=0,i=`_fzn_${e++}.fzn`;for(;i in this.vfs;)i=`_fzn_${e++}.fzn`;const o=["-c","--fzn",i];let s=!0,r=null;const u=this._run(o,t.options,[i]);return u.on("exit",(()=>s=!1)),u.on("error",(n=>{r||(r=n)})),{isRunning:()=>s,cancel(){u.emit("sigint")},on:(n,t)=>u.on(n,t),off:(n,t)=>u.off(n,t),then(n,t){u.on("exit",(e=>{if(0===e.code)n(e.outputFiles[i]);else{if(!t)throw e;t({...e,error:r})}}))}}}solve(n){const t={jsonOutput:!0,...n},e=["-i"];t.jsonOutput&&(e.push("--output-mode"),e.push("json"));let i=!0,o=null;const s=this._run(e,t.options);s.on("exit",(()=>i=!1));let r=null,u={},a="UNKNOWN";return s.on("statistics",(n=>{u={...u,...n.statistics}})),s.on("solution",(n=>{r=n,a="SATISFIED"})),s.on("status",(n=>{a=n.status})),s.on("error",(n=>{o||(o=n)})),{isRunning:()=>i,cancel(){s.emit("sigint")},on:(n,t)=>s.on(n,t),off:(n,t)=>s.off(n,t),then(n,t){s.on("exit",(e=>{if(0===e.code)n({status:a,solution:r,statistics:u});else{if(!t)throw e;t({...e,error:o})}}))}}}}exports.Model=a,exports.init=async function(n){if(n&&(r={...r,...n}),!/\\\//.test(r.minizinc)&&r.minizincPaths)for(const n of minizincPaths){const t=o.join(n,r.minizinc);try{await i.access(t),r._executable=t}catch{}}r._executable=r.minizinc},exports.shutdown=function(){for(const n of u)n.kill("SIGKILL");u.clear()},exports.solvers=function(){return new Promise(((t,e)=>{let i=null;i=n.execFile(r._executable,["--solvers-json"],((n,o,s)=>{u.delete(i),n&&e(n),t(JSON.parse(o))})),u.add(i)}))},exports.version=function(){return new Promise(((t,e)=>{let i=null;i=n.execFile(r._executable,["--version"],((n,o,s)=>{u.delete(i),n&&e(n),t(o)})),u.add(i)}))};
